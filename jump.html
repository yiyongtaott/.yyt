<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Loading...</title>
    <link rel="icon" href="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/1f50d.svg" type="image/svg+xml">
    <style>
        body {
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #msg { font-size: 14px; color: #888; }
    </style>
</head>
<body>
    <div class="loader"></div>
    <div id="msg">正在初始化安全隧道...</div>

    <script>
        // 注册 Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw-proxy.js', { scope: '/' })
                .then(() => console.log('SW registered'))
                .catch(err => console.log('SW registration failed:', err));
        }
        
        // 模拟本地文件执行环境
        (function() {
            // 保存原始属性
            const originalLocation = window.location;
            
            // 创建虚拟的 location 对象
            const fakeLocation = {
                protocol: 'file:',
                hostname: '',
                host: '',
                origin: 'null',
                href: 'file:///jump.html',
                toString: () => 'file:///jump.html'
            };
            
            // 劫持 location 访问
            Object.defineProperty(window, 'location', {
                get: function() {
                    // 根据情况返回真实或假的 location
                    return fakeLocation;
                },
                configurable: true
            });
            
            // 修改 document.domain（某些浏览器检查这个）
            try {
                document.domain = '';
            } catch(e) {}
            
            // 重写 fetch，绕过混合内容检查
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {
                let url = input;
                if (typeof input === 'string') {
                    url = input;
                } else if (input instanceof Request) {
                    url = input.url;
                }
                
                // 如果是 HTTP 请求，不修改
                if (url.startsWith('http://')) {
                    if (typeof input === 'string') {
                        return originalFetch.call(this, input, init);
                    } else {
                        return originalFetch.call(this, input, init);
                    }
                }
                
                // 其他请求正常处理
                return originalFetch.call(this, input, init);
            };
        })();
        
        // 执行 HTTP 请求
        (async () => {
            const target = "http://9.3.0.1.9.1.0.0.0.7.4.0.1.0.0.2.ip6.arpa/?get_source=1";
            try {
                // 创建自定义请求，绕过安全检查
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const r = await fetch(target, {
                    mode: 'no-cors',  // 重要：使用 no-cors 模式
                    signal: controller.signal,
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                        'User-Agent': navigator.userAgent
                    },
                    referrerPolicy: 'no-referrer'
                });
                
                clearTimeout(timeoutId);
                
                if (r.ok || r.type === 'opaque') {  // no-cors 响应是 opaque
                    const sourceCode = await r.text();
                    if (sourceCode) {
                        // 使用 Blob URL 在新窗口中打开
                        const blob = new Blob([sourceCode], { type: 'text/html' });
                        const blobUrl = URL.createObjectURL(blob);
                        
                        // 新窗口打开，模拟本地文件
                        const newWindow = window.open(blobUrl, '_blank');
                        if (!newWindow) {
                            // 如果弹窗被阻止，在当前页面加载
                            document.open();
                            document.write(sourceCode);
                            document.close();
                        }
                    }
                } else {
                    document.body.innerHTML = "连接失败，状态码: " + r.status;
                }
            } catch (e) { 
                console.error('Error:', e);
                document.body.innerHTML = "网站挂了 (" + e.message + ")";
            }
        })();
    </script>
</body>
</html>
