<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Connection Debugger</title>
    <style>
        body { background-color: #000; color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #msg { font-size: 14px; color: #888; white-space: pre-wrap; text-align: center; line-height: 1.6; }
        .button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <div class="loader" id="loader"></div>
    <div id="msg">准备分析连接路径...</div>
    <div id="buttons" style="display:none; margin-top:20px;"></div>

<script>
(function() {
    const target = "http://9.3.0.1.9.1.0.0.0.7.4.0.1.0.0.2.ip6.arpa/?get_source=1";
    const log = (tag, msg, color = '#3498db') => {
        const time = new Date().toLocaleTimeString();
        console.log(`%c[${time}][${tag}] %c${msg}`, `color: ${color}; font-weight: bold`, "color: #fff");
        document.getElementById('msg').innerHTML += `<br>[${tag}] ${msg}`;
    };

    // --- 方案测试函数 ---

    const methods = [
        {
            name: 'Image Beacon',
            desc: '最轻量，常用于埋点，但在 HTTPS -> HTTP 下极易被拦截',
            execute: () => new Promise(res => {
                const img = new Image();
                const start = Date.now();
                img.onload = () => res({ ok: true, time: Date.now() - start });
                img.onerror = () => res({ ok: false, msg: 'Blocked/Error' });
                img.src = target;
                setTimeout(() => res({ ok: false, msg: 'Timeout (3s)' }), 3000);
            })
        },
        {
            name: 'Script Injection',
            desc: 'JSONP 模式，会被严格执行 CSP 和 Mixed Content 检查',
            execute: () => new Promise(res => {
                const script = document.createElement('script');
                const start = Date.now();
                script.src = target;
                script.onload = () => { document.head.removeChild(script); res({ ok: true, time: Date.now() - start }); };
                script.onerror = () => res({ ok: false, msg: 'CSP/Security Block' });
                document.head.appendChild(script);
                setTimeout(() => res({ ok: false, msg: 'Timeout (3s)' }), 3000);
            })
        },
        {
            name: 'Form Submission',
            desc: '【最强兼容】通过 Target=_blank 或 Iframe 提交，浏览器限制最少',
            execute: () => new Promise(res => {
                const iframeName = 'proxy_frame_' + Date.now();
                const iframe = document.createElement('iframe');
                iframe.name = iframeName;
                iframe.style.display = 'none';
                
                const form = document.createElement('form');
                form.method = 'GET';
                form.action = target;
                form.target = iframeName;
                
                document.body.appendChild(iframe);
                document.body.appendChild(form);
                
                try {
                    form.submit();
                    // 注意：Form 提交到 Iframe 很难捕获是否真的成功加载内容
                    // 但通常请求确实发出去了
                    setTimeout(() => res({ ok: true, msg: 'Request Sent (Blind)' }), 2000);
                } catch (e) {
                    res({ ok: false, msg: e.message });
                }
            })
        }
    ];

    async function runDebug() {
        log('SYSTEM', '开始探测目标: ' + target, '#f1c40f');
        
        for (const m of methods) {
            log(m.name, `测试中... (${m.desc})`, '#9b59b6');
            const result = await m.execute();
            
            if (result.ok) {
                log(m.name, `✅ 成功! ${result.time ? result.time + 'ms' : result.msg}`, '#2ecc71');
            } else {
                log(m.name, `❌ 失败: ${result.msg}`, '#e74c3c');
            }
        }

        document.getElementById('loader').style.display = 'none';
        document.getElementById('buttons').style.display = 'block';
        document.getElementById('buttons').innerHTML = `
            <button class="button" onclick="window.open('${target}', '_blank')">强制手动打开 (100% 成功)</button>
            <button class="button" onclick="location.reload()">重新测试</button>
        `;
    }

    window.onload = runDebug;
})();
</script>
</body>
</html>
