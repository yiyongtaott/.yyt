<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>代理页面</title>
</head>
<body>
    <div id="content">代理页面加载中...</div>

    <script>
        // 获取 URL 参数
        const urlParams = new URLSearchParams(window.location.search);
        const targetUrl = urlParams.get('url');
        const mode = urlParams.get('mode'); // raw 模式直接返回内容
        
        if (!targetUrl) {
            document.getElementById('content').innerHTML = '<h2>错误：未指定URL</h2>';
            return;
        }
        
        // 如果是 raw 模式，直接获取并返回内容
        if (mode === 'raw') {
            (async () => {
                try {
                    // 使用 CORS 代理绕过限制
                    const proxyServices = [
                        'https://api.allorigins.win/raw?url=',
                        'https://corsproxy.io/?',
                        'https://api.codetabs.com/v1/proxy?quest='
                    ];
                    
                    let lastError = null;
                    
                    for (const proxy of proxyServices) {
                        try {
                            const proxyUrl = proxy + encodeURIComponent(targetUrl);
                            const response = await fetch(proxyUrl, {
                                headers: {
                                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                                }
                            });
                            
                            if (response.ok) {
                                const content = await response.text();
                                
                                // 直接输出内容（作为纯文本）
                                document.open();
                                document.write(content);
                                document.close();
                                return;
                            }
                        } catch (error) {
                            lastError = error;
                            continue;
                        }
                    }
                    
                    // 所有代理都失败了，尝试直接 iframe
                    document.open();
                    document.write(`
                        <iframe 
                            src="${targetUrl}" 
                            style="width:100%;height:100vh;border:none;"
                            sandbox="allow-scripts allow-same-origin">
                        </iframe>
                    `);
                    document.close();
                    
                } catch (error) {
                    document.getElementById('content').innerHTML = `
                        <h2>代理失败</h2>
                        <p>${error.message}</p>
                    `;
                }
            })();
        } else {
            // 正常模式显示界面
            document.getElementById('content').innerHTML = `
                <style>
                    body { margin: 0; padding: 20px; font-family: sans-serif; }
                    iframe { width: 100%; height: 90vh; border: 2px solid #ccc; }
                </style>
                <h2>HTTP 代理页面</h2>
                <iframe 
                    src="${targetUrl}" 
                    sandbox="allow-scripts allow-same-origin">
                </iframe>
                <p><small>正在加载: ${targetUrl}</small></p>
            `;
        }
    </script>
</body>
</html>
